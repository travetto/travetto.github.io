<div class="documentation"><h1 id="base">Base</h1>
<p>Base is the foundation of all <code>travetto</code> applications.  It is intended to be a minimal application bootstrap, as well as support<br>for commonly shared functionality. The key areas that it offers</p>
<h2 id="general-app-info">General App Info</h2>
<p>This is a programmatic interface to <code>package.json</code>, which provides key information on:</p>
<ul>
<li>Application Name</li>
<li>Version</li>
<li>Package</li>
<li>Development Dependencies</li>
<li>â€¦more</li>
</ul>
<h2 id="bulk-file-system-operations">Bulk File System Operations</h2>
<p>The framework does a bit of file system scanning to auto load files, and to have knowledge of what files are<br>available. The tools provide:</p>
<ul>
<li>Very simple functionality for recursively finding files, and caching the results</li>
<li>Utilizes RegEx in lieu of glob for pattern matching on files (this is to minimize overall code complexity)</li>
</ul>
<p>A simple example of finding all <code>.config</code> files in your codebase:</p>
<pre><code class="language-typescript">  <span class="token keyword">function</span> <span class="token function">processServiceConfigs</span><span class="token punctuation">(</span>svc<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">const</span> svcConfigs <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">findAppFiles</span><span class="token punctuation">(</span><span class="token string">'.config'</span><span class="token punctuation">,</span> file <span class="token operator">=></span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${{ '{' }}</span>svc<span class="token interpolation-punctuation punctuation">{{ '}' }}</span></span><span class="token string">.`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> conf <span class="token keyword">of</span> svcConfigs<span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
      <span class="token operator">...</span> <span class="token keyword">do</span> work
    <span class="token punctuation">{{ '}' }}</span>
  <span class="token punctuation">{{ '}' }}</span></code></pre><h2 id="environmental-information">Environmental Information</h2>
<p>The framework provides basic environment information, e.g. in prod/test/dev.  This is useful for runtime decisions.  This is primarily used<br>by the framework, but can prove useful to application developers as well. The information that is available is:</p>
<ul>
<li><code>prod: boolean</code> - is the application in prod mode </li>
<li><code>dev: boolean</code> - is the application in development mode</li>
<li><code>test: boolean</code> - is the application currently in test mode</li>
<li><code>watch: boolean</code> - is the application currently watching for file changes and reloads (normally only during development)</li>
<li><code>all: string[]</code> - a list of all the environments that are passed in and configured</li>
<li><code>docker: boolean</code> - does the environment support docker, and should it use it if needed</li>
<li><code>debug: boolean</code> - is the application currently in debug mode</li>
<li><code>trace: boolean</code> - is the application currently in trace mode</li>
<li><code>cwd: string</code> - what is the root folder of the application</li>
</ul>
<h2 id="shutdown">Shutdown</h2>
<p>This is centralized functionality for running operations on shutdown.  Primarily used by the framework for cleanup operations, this provides a clean interface for registering shutdown handlers and awaiting shutdown to finish.</p>
<p>As a registered handler, you can do.</p>
<pre><code class="language-typescript">Shutdown<span class="token punctuation">.</span><span class="token function">onShutdown</span><span class="token punctuation">(</span><span class="token string">'handler-name'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token comment">// Do important work</span>
<span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span></code></pre><p>If knowing when shutdown finishes is all you want, you can simply use:</p>
<pre><code class="language-typescript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">messageOnShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token keyword">await</span> Shutdown<span class="token punctuation">.</span><span class="token function">onShutdownPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Shutdown is complete!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><h2 id="stacktrace">Stacktrace</h2>
<p>Integration with <a class="external-link" href="https://trace.js.org/" target="_blank" null><code>trace.js</code></a> to handle asynchronous call stacks, and provide higher quality stack traces.  The stack filtering will remove duplicate or unnecessary lines, as well as filter out framework specific steps that do not aid in debugging.  The final result should be a stack trace that is concise and clear.</p>
<p>From a test scenario:</p>
<pre><code class="language-typescript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">inner1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">inner2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">inner3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Uh oh'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{{ '}' }}</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Will produce the following stack trace:</p>
<pre><code>Error: Uh oh
    at Timeout.inner3 [as _onTimeout] (./test/stack.js:6:23)
    at Timeout.inner2 [as _onTimeout] (./test/stack.js:5:13)
    at Timeout.inner1 [as _onTimeout] (./test/stack.js:4:9)
    at Object.load [as .ts] (./bin/travetto.js:27:12)</code></pre><h2 id="phase-management">Phase management</h2>
<p>During the lifecycle of an application, there is a need to handle different phases of execution</p>
<ul>
<li>Recursively finds all <code>phase.&lt;phase&gt;.ts</code> files under <code>node_modules/@travetto</code>, and in the root of your project</li>
<li>The format of each initializer is comprised of three main elements:<ol>
<li>The phase of execution, which is defined by the file name <code>phase.&lt;phase&gt;.ts</code></li>
<li>The priority within the phase, a number in which lower is of higher importance</li>
<li>The actual functionality to execute</li>
</ol>
</li>
</ul>
<p>An example would be something like <code>phase.bootstrap.ts</code> in the <a class="module-link" routerLink="/docs/config" null><code>Config</code></a> module.  </p>
<pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">const</span> init <span class="token operator">=</span> <span class="token punctuation">{{ '{' }}</span>
  priority<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// Lower is of more importance, and runs first</span>
  action<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'../src/service/config'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><p>The needed functionality cannot be loaded until <code>init.action</code> executes, and so must be required only at that time.</p>
<h2 id="util">Util</h2>
<p>Simple functions for providing a minimal facsimile to <a class="external-link" href="https://lodash.com" target="_blank" null><code>lodash</code></a>, but without all the weight. Currently <code>util</code> only includes:</p>
<ul>
<li><code>isPrimitive(el: any)</code> determines if <code>el</code> is a <code>string</code>, <code>boolean</code>, <code>number</code> or <code>RegExp</code></li>
<li><code>isPlainObject(obj: any)</code> determines if the obj is a simple object</li>
<li><code>isFunction(o: any)</code> determines if <code>o</code> is a simple <code>Function</code></li>
<li><code>isClass(o: any)</code> determines if <code>o</code> is a class constructor</li>
<li><code>isSimple(a: any)</code> determines if <code>a</code> is a simple value</li>
<li><code>deepAssign(a: any, b: any, mode?)</code> which allows for deep assignment of <code>b</code> onto <code>a</code>, the <code>mode</code> determines how aggressive the assignment is, and how flexible it is.  <code>mode</code> can have any of the following values:<ul>
<li><code>loose</code>, which is the default is the most lenient.  It will not error out, and overwrites will always happen</li>
<li><code>coerce</code>, will attempt to force values from <code>b</code> to fit the types of <code>a</code>, and if it canâ€™t it will error out</li>
<li><code>strict</code>, will error out if the types do not match  </li>
</ul>
</li>
<li><code>throttle(fn, threshhold?: number)</code> produces a function that will execute <code>fn</code>, at most once per <code>threshold</code></li>
</ul>
<h2 id="watch">Watch</h2>
<p>A very simple file watching library, with a substantially smaller footprint than <a class="external-link" href="https://github.com/shama/gaze" target="_blank" null><code>gaze</code></a> or <a class="external-link" href="https://github.com/paulmillr/chokidar" target="_blank" null><code>chokidar</code></a>.  </p>
<pre><code class="language-typescript"><span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">{{ '{' }}</span>cwd<span class="token punctuation">:</span> <span class="token string">'base/path/to/...'</span><span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
watcher<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token string">'local.config'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{{ '{' }}</span>
    testFile<span class="token punctuation">:</span> x <span class="token operator">=></span> x<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.config'</span><span class="token punctuation">)</span> <span class="token operator">||</span> x<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.config.json'</span><span class="token punctuation">)</span>
  <span class="token punctuation">{{ '}' }}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
watcher<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
