<div class="documentation"><h1 id="model">Model</h1>
<p>This module provides a clean interface to data model persistence, modification and retrieval.  This module builds heavily upon the <a class="module-link" routerLink="/docs/schema" null><code>Schema</code></a>, which is used for data model validation.</p>
<p>The module can be segmented into three main areas: Model declaration, access/storage, and querying</p>
<h2 id="declaration">Declaration</h2>
<p>Models are declared via the <code class="decorator">@Model</code> decorator, which allows the system to know that this is a class that is compatible with the module.</p>
<pre><code class="language-typescript">@<span class="token meta">Model</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">BaseModel</span> <span class="token punctuation">{{ '{' }}</span>
  name<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  age<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  contact<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">{{ '}' }}</span></code></pre><p>The <code>User</code> model is now ready to be used with the model services.</p>
<h2 id="access-storage">Access/Storage</h2>
<p>The <a class="source-link" href="https://githhub.com/travetto/model/tree/master/src/service/model.ts" target="_blank" null><code>ModelService</code></a> is the foundation for all access to the storage layer, and provides a comprehensive set of functionality.  The service includes support for modifying individual records, bulk update/insert/delete, partial updates, finding records, and more.  This should be the expected set of functionality for storage and retrieval.</p>
<pre><code class="language-typescript"><span class="token keyword">class</span> <span class="token class-name">UserManager</span> <span class="token punctuation">{{ '{' }}</span>
  <span class="token keyword">private</span> service<span class="token punctuation">:</span> ModelService<span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">register</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> User<span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">const</span> created <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span> send welcome email <span class="token operator">...</span>
    <span class="token keyword">return</span> created<span class="token punctuation">;</span>
  <span class="token punctuation">{{ '}' }}</span>

  <span class="token keyword">async</span> <span class="token function">bulkCreate</span><span class="token punctuation">(</span>users<span class="token punctuation">:</span> User<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{{ '{' }}</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">bulkProcess</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token punctuation">{{ '{' }}</span>
      insert<span class="token punctuation">:</span> users
    <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span> notify administrator <span class="token keyword">of</span> completion <span class="token operator">...</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span> 
  <span class="token punctuation">{{ '}' }}</span>
<span class="token punctuation">{{ '}' }}</span>
</code></pre><p>The <a class="source-link" href="https://githhub.com/travetto/model/tree/master/src/service/model.ts" target="_blank" null><code>ModelService</code></a> itself relies upon a <a class="source-link" href="https://githhub.com/travetto/model/tree/master/src/service/source.ts" target="_blank" null><code>ModelSource</code></a> which is the driver for the storage layer. Currently the only <code>ModelSource</code> implementations are for <a class="external-link" href="https://mongodb.com" target="_blank" null><code>mongodb</code></a> and <a class="external-link" href="https://elastic.co" target="_blank" null><code>elasticsearch</code></a>, with sql support on the roadmap.</p>
<p>During development, <code>ModelSource</code> supports the ability to respond to model changes in real-time, and to modify the underlying storage mechanism.  An example of this would be <code>elasticsearch</code> schemas being updated as fields are added or removed from the <code>Model</code> class.</p>
<p>Additionally there is a class <a class="source-link" href="https://githhub.com/travetto/model/tree/master/src/service/class-model.ts" target="_blank" null><code>ClassModelService</code></a> that provides a wrapper around <code>ModelService</code> that is tied to a specific <code>Model</code> class.  This can be useful if you want to constrain the model access or if you have a high volume of function calls for the same model.</p>
<h2 id="querying">Querying</h2>
<p>One of the complexities of abstracting multiple storage mechanisms, is providing a consistent query language.  The query language the module uses is a derivation of <code>mongodb</code>‘s query language, with some restrictions, additions, and caveats. Additionally, given the nature of typescript, all queries are statically typed, and will catch type errors at compile time.</p>
<h3 id="general-fields">General Fields</h3>
<ul>
<li><code class="inline language-typescript">field : {{ '{' }} $eq : T {{ '}' }}</code> to determine if a field is equal to a value</li>
<li><code class="inline language-typescript">field : {{ '{' }} $ne: T {{ '}' }}</code> to determine if a field is not equal to a value</li>
<li><code class="inline language-typescript">field : {{ '{' }} $exists : boolean {{ '}' }}</code> to determine if a field exists or not</li>
<li><code class="inline language-typescript">field : T</code> to see if the field is equal to whatever value is passed in</li>
</ul>
<h3 id="general-single-valued-fields">General Single Valued Fields</h3>
<ul>
<li><code class="inline language-typescript">field : {{ '{' }} $in : T[] {{ '}' }}</code> to see if a record’s value appears in the array provided to <code>$in</code></li>
<li><code class="inline language-typescript">field : {{ '{' }} $nin: T[] {{ '}' }}</code> to see if a record’s value does not appear in the array provided to <code>$in</code></li>
</ul>
<h3 id="ordered-fields">Ordered Fields</h3>
<ul>
<li><code class="inline language-typescript">field : {{ '{' }} $lt: T {{ '}' }}</code> checks if value is less than</li>
<li><code class="inline language-typescript">field : {{ '{' }} $lte: T {{ '}' }}</code> checks if value is less than or equal to</li>
<li><code class="inline language-typescript">field : {{ '{' }} $gt: T {{ '}' }}</code> checks if value is greater than</li>
<li><code class="inline language-typescript">field : {{ '{' }} $gte : T {{ '}' }}</code> checks if value is greater than or equal to</li>
</ul>
<h3 id="array-fields">Array Fields</h3>
<ul>
<li><code class="inline language-typescript">field : {{ '{' }} $all: T[]] {{ '}' }}</code> checks to see if the records value contains everything within <code>$all</code></li>
</ul>
<h3 id="string-fields">String Fields</h3>
<ul>
<li><code class="inline language-typescript">field : {{ '{' }} $regex: RegExp; {{ '}' }}</code> checks the field against the regular expression</li>
</ul>
<h3 id="geo-point-fields">Geo Point Fields</h3>
<ul>
<li><code class="inline language-typescript">field : {{ '{' }} $geoWithin: Point[] {{ '}' }}</code> determines if the value is within the bounding region of the points</li>
<li><code class="inline language-typescript">field : {{ '{' }} $geoIntersects: Point[] {{ '}' }}</code> determines if the value intersects with the bounding region of the points</li>
</ul>
<h3 id="groupings">Groupings</h3>
<ul>
<li><code class="inline language-typescript">{{ '{' }} $and: [] {{ '}' }}</code> provides a grouping in which all sub clauses are required</li>
<li><code class="inline language-typescript">{{ '{' }} $or: [] {{ '}' }}</code> provides a grouping in which at least one of the sub clauses is required</li>
<li><code class="inline language-typescript">{{ '{' }} $not : {{ '{' }}{{ '}' }} {{ '}' }}</code> negates a clause</li>
</ul>
<p>A sample query for <code>User</code>s might be:</p>
<pre><code class="language-typescript"><span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">getAllByQuery</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token punctuation">{{ '{' }}</span>
  $and<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{{ '{' }}</span> 
      $not <span class="token punctuation">:</span> <span class="token punctuation">{{ '{' }}</span>
        age <span class="token punctuation">:</span> <span class="token punctuation">{{ '{' }}</span>
          $lt <span class="token punctuation">:</span> <span class="token number">35</span>
        <span class="token punctuation">{{ '}' }}</span>
      <span class="token punctuation">{{ '}' }}</span>
    <span class="token punctuation">{{ '}' }}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{{ '{' }}</span>
      contact <span class="token punctuation">:</span> <span class="token punctuation">{{ '{' }}</span>
        $exists<span class="token punctuation">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">{{ '}' }}</span>
    <span class="token punctuation">{{ '}' }}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">{{ '}' }}</span><span class="token punctuation">)</span></code></pre><p>This would find all users who are over 35 and that have the <code>contact</code> field specified. </p>
</div>
